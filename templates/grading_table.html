<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LPP Eval - {{ type_id }} Grading Table</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .grading-table {
            font-size: 0.85rem;
        }
        .grading-table th {
            position: sticky;
            top: 0;
            background: #212529;
            color: white;
            z-index: 10;
        }
        .grading-table th.project-header {
            position: sticky;
            left: 0;
            z-index: 20;
        }
        .grading-table td.project-cell {
            position: sticky;
            left: 0;
            background: #f8f9fa;
            font-weight: bold;
            z-index: 5;
        }
        .cell-passed {
            background-color: #d1e7dd !important;
            text-align: center;
        }
        .cell-failed {
            background-color: #f8d7da !important;
            text-align: center;
        }
        .cell-not-submitted {
            background-color: #e9ecef !important;
            text-align: center;
            color: #6c757d;
        }
        .testcase-header {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            max-width: 40px;
            height: 120px;
            padding: 5px 2px;
            font-size: 0.75rem;
        }
        .summary-cell {
            font-weight: bold;
        }
        .table-container {
            max-height: 80vh;
            overflow: auto;
        }
        .timing-on_time {
            background-color: #d1e7dd !important;
        }
        .timing-resubmission {
            background-color: #fff3cd !important;
        }
        .timing-late {
            background-color: #f8d7da !important;
        }
        .timing-unknown {
            background-color: #e9ecef !important;
        }
        .timing-badge {
            font-size: 0.7rem;
            padding: 2px 5px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <a href="/" class="navbar-brand">LPP Eval</a>
        </div>
    </nav>

    <div class="container-fluid">
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item"><a href="/grading">Grading Table</a></li>
                <li class="breadcrumb-item active">{{ type_id }}</li>
            </ol>
        </nav>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h2>{{ type_id }} - Grading Table</h2>
                <p class="text-muted mb-0">
                    Deadline: {{ deadline | jst if deadline else '未設定' }}
                    <a href="/deadlines" class="ms-2 small">[Edit]</a>
                </p>
            </div>
            <div>
                <span class="badge bg-success me-2">○ Passed</span>
                <span class="badge bg-danger me-2">× Failed</span>
                <span class="badge bg-secondary me-3">- Not Submitted</span>
                <span class="badge timing-on_time me-1">期限内</span>
                <span class="badge timing-resubmission me-1">再提出</span>
                <span class="badge timing-late">期限後</span>
            </div>
        </div>

        {% if project_ids %}
        <div class="table-container">
            <table class="table table-bordered grading-table">
                <thead>
                    <tr>
                        <th class="project-header">Project ID</th>
                        <th>Name</th>
                        <th>Timing</th>
                        <th>Score</th>
                        <th>Total</th>
                        {% for tc in testcase_list %}
                        <th class="testcase-header" title="{{ tc }}">{{ tc }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for project_id in project_ids %}
                    {% set data = submission_results.get(project_id) %}
                    <tr>
                        <td class="project-cell">
                            {% if data %}
                            <a href="/submission/{{ data.submission.id }}">{{ project_id }}</a>
                            {% else %}
                            {{ project_id }}
                            {% endif %}
                        </td>
                        <td>{{ student_names.get(project_id, '-') }}</td>
                        {% if data %}
                            {% set timing = calculate_timing(data.submission, deadline) %}
                        {% else %}
                            {% set timing = 'unknown' %}
                        {% endif %}
                        <td class="timing-{{ timing }}" style="text-align: center;">
                            {% if data %}
                                {% if timing == 'on_time' %}
                                期限内
                                {% elif timing == 'resubmission' %}
                                再提出
                                {% elif timing == 'late' %}
                                期限後
                                {% else %}
                                -
                                {% endif %}
                            {% else %}
                            未提出
                            {% endif %}
                        </td>
                        <td class="summary-cell" style="text-align: center;">
                            {% if data and data.score is not none %}
                            {{ "%.1f"|format(data.score) }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td class="summary-cell">
                            {% if data %}
                            {{ data.submission.passed }}/{{ data.submission.total }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        {% for tc in testcase_list %}
                        {% if data %}
                            {% set outcome = data.results.get(tc) %}
                            {% if outcome == 'passed' %}
                            <td class="cell-passed" title="{{ tc }}: passed">○</td>
                            {% elif outcome == 'failed' %}
                            <td class="cell-failed" title="{{ tc }}: failed">×</td>
                            {% else %}
                            <td class="cell-not-submitted" title="{{ tc }}: not run">-</td>
                            {% endif %}
                        {% else %}
                        <td class="cell-not-submitted" title="Not submitted">-</td>
                        {% endif %}
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="mt-3">
            <p class="text-muted">
                Total: {{ project_ids | length }} projects, {{ testcase_list | length }} test cases
            </p>
        </div>
        {% else %}
        <div class="alert alert-info">
            No submissions found for {{ type_id }}.
        </div>
        {% endif %}

        <div class="mt-3 mb-4">
            <a href="/grading" class="btn btn-secondary">Back to Type Selection</a>
            <a href="/grading/{{ type_id }}/csv" class="btn btn-success ms-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download me-1" viewBox="0 0 16 16">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                </svg>
                CSV Download
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
