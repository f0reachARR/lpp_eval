<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      Submission Detail - {{ submission.project_id }}/{{ submission.type_id }}
    </title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .status-completed {
        color: #198754;
      }
      .status-running {
        color: #0d6efd;
      }
      .status-pending {
        color: #6c757d;
      }
      .status-error {
        color: #dc3545;
      }
      .outcome-passed {
        color: #198754;
        font-weight: bold;
      }
      .outcome-failed {
        color: #dc3545;
        font-weight: bold;
      }
      .timing-on_time {
        color: #198754;
        font-weight: bold;
      }
      .timing-resubmission {
        color: #fd7e14;
        font-weight: bold;
      }
      .timing-late {
        color: #dc3545;
        font-weight: bold;
      }
      .timing-unknown {
        color: #6c757d;
      }
      pre.stdout {
        background-color: #1e1e1e;
        color: #d4d4d4;
        padding: 1rem;
        border-radius: 0.5rem;
        max-height: 400px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-dark bg-dark mb-4">
      <div class="container">
        <a href="/" class="navbar-brand">LPP Eval</a>
      </div>
    </nav>

    <div class="container">
      <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/">Submissions</a></li>
          <li class="breadcrumb-item active">
            {{ submission.project_id }}/{{ submission.type_id }}
          </li>
        </ol>
      </nav>

      <div class="card mb-4">
        <div class="card-header">
          <h4 class="mb-0">Submission Information</h4>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <table class="table table-borderless">
                <tr>
                  <th>Project ID:</th>
                  <td>{{ submission.project_id }}</td>
                </tr>
                <tr>
                  <th>Type:</th>
                  <td>{{ submission.type_id }}</td>
                </tr>
                <tr>
                  <th>Test Suite:</th>
                  <td>{{ submission.testcase_id or '-' }}</td>
                </tr>
                <tr>
                  <th>Status:</th>
                  <td>
                    <span class="status-{{ submission.status }}"
                      >{{ submission.status }}</span
                    >
                  </td>
                </tr>
                {% set timing = calculate_timing(submission, deadline) %}
                <tr>
                  <th>Submission Timing:</th>
                  <td>
                    <span class="timing-{{ timing }}">
                      {% if timing == 'on_time' %} 期限内提出 {% elif timing ==
                      'resubmission' %} 再提出（期限内提出後） {% elif timing ==
                      'late' %} 期限後提出 {% else %} 不明 {% endif %}
                    </span>
                    {% if deadline %}
                    <small class="text-muted"
                      >(期限: {{ deadline | jst }})</small
                    >
                    {% endif %}
                  </td>
                </tr>
              </table>
            </div>
            <div class="col-md-6">
              <table class="table table-borderless">
                <tr>
                  <th>Result:</th>
                  <td>
                    {% if submission.total > 0 %}
                    <strong
                      >{{ submission.passed }} / {{ submission.total }}</strong
                    >
                    ({{ (submission.passed / submission.total * 100) | round(1)
                    }}%) {% else %} - {% endif %}
                  </td>
                </tr>
                <tr>
                  <th>First Submitted:</th>
                  <td>
                    {{ submission.first_submitted_at | jst('%Y-%m-%d %H:%M:%S')
                    }}
                  </td>
                </tr>
                <tr>
                  <th>Current Submitted:</th>
                  <td>
                    {{ submission.submitted_at | jst('%Y-%m-%d %H:%M:%S') }}
                  </td>
                </tr>
                <tr>
                  <th>Evaluated:</th>
                  <td>
                    {{ submission.evaluated_at | jst('%Y-%m-%d %H:%M:%S') }}
                  </td>
                </tr>
                <tr>
                  <th>Attachment ID:</th>
                  <td>{{ submission.attachment_id }}</td>
                </tr>
              </table>
            </div>
          </div>

          {% if submission.other_info %}
          <div class="mt-3">
            <strong>Other Info:</strong>
            <p class="text-muted mb-0">{{ submission.other_info }}</p>
          </div>
          {% endif %} {% if submission.failed %}
          <div class="mt-3">
            <strong>Failed Tests:</strong>
            <p class="text-danger mb-0">{{ submission.failed }}</p>
          </div>
          {% endif %}
        </div>
      </div>

      {% if test_results %}
      <div class="card mb-4">
        <div class="card-header">
          <h4 class="mb-0">Test Case Results</h4>
        </div>
        <div class="card-body">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Test Name</th>
                <th>Outcome</th>
              </tr>
            </thead>
            <tbody>
              {% for result in test_results %}
              <tr>
                <td>{{ result.name }}</td>
                <td class="outcome-{{ result.outcome }}">
                  {{ result.outcome }}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %} {% if submission.stdout %}
      <div class="card mb-4">
        <div class="card-header">
          <h4 class="mb-0">Test Output</h4>
        </div>
        <div class="card-body">
          <pre class="stdout">{{ submission.stdout }}</pre>
        </div>
      </div>
      {% endif %} {% if submission.type_id.startswith("report") %}
      <embed
        src="{{ url_for('api_get_submission_attachment', submission_id=submission.id) }}"
        type="application/pdf"
        width="100%"
        height="600px"
      />
      {% endif %}

      <div class="d-flex gap-2 mb-4">
        <a href="/" class="btn btn-secondary">Back to List</a>
        <button id="rerunBtn" class="btn btn-warning" onclick="rerunSubmission()">
          Re-run Evaluation
        </button>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function rerunSubmission() {
        if (!confirm('Are you sure you want to re-run evaluation for this submission?')) {
          return;
        }
        const btn = document.getElementById('rerunBtn');
        btn.disabled = true;
        btn.textContent = 'Queuing...';

        fetch('/api/submission/{{ submission.id }}/rerun', { method: 'POST' })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              alert('Re-evaluation queued successfully. The page will reload.');
              location.reload();
            } else {
              alert('Error: ' + (data.message || 'Unknown error'));
              btn.disabled = false;
              btn.textContent = 'Re-run Evaluation';
            }
          })
          .catch(err => {
            alert('Request failed: ' + err);
            btn.disabled = false;
            btn.textContent = 'Re-run Evaluation';
          });
      }
    </script>
  </body>
</html>
