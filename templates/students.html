<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LPP Eval - Students</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <nav class="navbar navbar-dark bg-dark mb-4">
      <div class="container">
        <a href="/" class="navbar-brand">LPP Eval</a>
      </div>
    </nav>

    <div class="container">
      <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/">Home</a></li>
          <li class="breadcrumb-item active">Students</li>
        </ol>
      </nav>

      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Student List</h2>
        <button class="btn btn-primary" onclick="syncStudents()" id="syncBtn">
          Sync from Redmine
        </button>
      </div>

      <p class="text-muted mb-4">
        Redmineのプロジェクトから「Student」ロールのユーザーを取得します。
        環境変数 <code>STUDENT_ROLE_NAME</code> でロール名を変更できます。
      </p>

      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th>Project ID</th>
              <th>Name</th>
              <th>Redmine User ID</th>
              <th>Created At</th>
            </tr>
          </thead>
          <tbody>
            {% for student in students %}
            <tr>
              <td>{{ student.project_id }}</td>
              <td>{{ student.name }}</td>
              <td>{{ student.redmine_user_id or '-' }}</td>
              <td>
                {{ student.created_at | jst }}
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="4" class="text-center text-muted">
                No students found. Click "Sync from Redmine" to fetch students.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <p class="text-muted">Total: {{ students | length }} students</p>

      <a href="/" class="btn btn-secondary mt-3">Back to Home</a>

      <div
        id="toast-container"
        class="position-fixed bottom-0 end-0 p-3"
        style="z-index: 1050"
      ></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function showToast(message, isError = false) {
        const container = document.getElementById("toast-container");
        const toastId = "toast-" + Date.now();
        const html = `
                <div id="${toastId}" class="toast align-items-center text-white ${isError ? "bg-danger" : "bg-success"}" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
        container.insertAdjacentHTML("beforeend", html);
        const toastEl = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
        toastEl.addEventListener("hidden.bs.toast", () => toastEl.remove());
      }

      function syncStudents() {
        const btn = document.getElementById("syncBtn");
        btn.disabled = true;
        btn.innerHTML =
          '<span class="spinner-border spinner-border-sm me-1"></span>Syncing...';

        fetch("/api/students/sync", { method: "POST" })
          .then((res) => res.json())
          .then((data) => {
            btn.disabled = false;
            btn.innerHTML = "Sync from Redmine";

            showToast("Sync started", false);
          })
          .catch((err) => {
            btn.disabled = false;
            btn.innerHTML = "Sync from Redmine";
            showToast("Error: " + err, true);
          });
      }
    </script>
  </body>
</html>
